<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Flodsvin.no | Flappy Flodsvin</title>
    <meta name="description" content="Spill Flappy Flodsvin! Tjen mynter til hovedspillet.">

    <!-- Open Graph & Meta -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://flodsvin.no/flappy">
    <meta property="og:title" content="Flodsvin.no | Flappy Flodsvin">
    <meta property="og:image" content="https://flodsvin.no/meta.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;900&display=swap" rel="stylesheet">

<style>
    :root {
        --primary: #00b894;
        --accent: #fdcb6e;
        --danger: #ff7675;
        --dark: #2d3436;
        --radius-box: 24px;
        --radius-btn: 50px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
        font-family: 'Fredoka', sans-serif;
        /* Optimistisk Oransje Bakgrunn */
        background: linear-gradient(135deg, #f0932b, #ffbe76); 
        height: 100dvh; 
        width: 100%;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        touch-action: none; 
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    /* --- GAME CONTAINER --- */
    #game-container {
        position: relative;
        width: 100%;
        height: 100%;
        max-width: 480px; 
        background: #81ecec; /* Default sky color */
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }

    @media (min-width: 600px) {
        #game-container {
            height: 90vh;
            border-radius: 30px;
            border: 8px solid #ffffff; 
        }
    }

    canvas {
        display: block;
        width: 100%;
        height: 100%;
        image-rendering: pixelated; 
    }

    /* --- UI TEXT --- */
    h1 {
        position: absolute;
        top: 15%;
        width: 100%;
        text-align: center;
        color: #fff;
        font-size: 3.5rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 2px;
        -webkit-text-stroke: 6px var(--dark);
        paint-order: stroke fill;
        text-shadow: 4px 4px 0px rgba(0,0,0,0.1);
        z-index: 10;
        pointer-events: none;
        transform: rotate(-3deg);
        animation: floatTitle 3s ease-in-out infinite;
    }
    @keyframes floatTitle { 0%,100%{transform:rotate(-3deg) translateY(0);} 50%{transform:rotate(-3deg) translateY(-10px);} }

    #game-score {
        position: absolute; top: 10%; width: 100%; text-align: center;
        font-size: 5rem; font-weight: 900; color: white;
        -webkit-text-stroke: 6px var(--dark); 
        paint-order: stroke fill;
        pointer-events: none; display: none; z-index: 20;
    }

    #instruction-text {
        position: absolute;
        top: 60%; left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: white;
        font-weight: 900;
        font-size: 1.8rem;
        -webkit-text-stroke: 3px var(--dark);
        paint-order: stroke fill;
        z-index: 15;
        pointer-events: none;
        animation: pulse 1s infinite alternate;
    }
    @keyframes pulse { from{transform:translate(-50%,-50%) scale(1);} to{transform:translate(-50%,-50%) scale(1.1);} }

    /* --- RESULT SCREEN --- */
    #result-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 159, 67, 0.8); /* Oransje tint */
        backdrop-filter: blur(5px);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 30;
    }

    .card {
        background: #fff;
        padding: 30px;
        border-radius: var(--radius-box);
        border: 4px solid var(--dark);
        box-shadow: 8px 8px 0 var(--dark);
        text-align: center;
        width: 85%;
        max-width: 320px;
        transform: scale(0.8);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .card.show { transform: scale(1); opacity: 1; }

    .card h2 {
        font-size: 2.2rem;
        color: var(--danger);
        margin-bottom: 20px;
        font-weight: 900;
        -webkit-text-stroke: 2px var(--dark);
        paint-order: stroke fill;
    }

    .stats-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;
    }
    .stat-box {
        background: #dfe6e9; border: 3px solid var(--dark); border-radius: 15px; padding: 10px;
    }
    .stat-label { font-size: 0.8rem; font-weight: 800; color: #636e72; text-transform: uppercase; }
    .stat-value { font-size: 1.8rem; font-weight: 900; color: var(--dark); }

    .coin-box {
        grid-column: span 2; background: #ffeaa7; color: var(--dark);
        border: 3px solid var(--dark); border-radius: 15px; padding: 12px;
        font-size: 1.4rem; font-weight: 900;
        display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .coin-icon { animation: spin 3s linear infinite; display:inline-block; }
    @keyframes spin { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }

    .btn {
        background: var(--primary); color: white; font-size: 1.3rem; padding: 15px 0;
        width: 100%; border-radius: var(--radius-btn); border: 3px solid var(--dark);
        font-weight: 900; cursor: pointer; text-transform: uppercase;
        box-shadow: 0 6px 0 #008c70; margin-top: 10px;
        transition: transform 0.1s;
    }
    .btn:active { transform: translateY(6px); box-shadow: none; }

    .back-link {
        margin-top: 20px; color: white; font-weight: 900; cursor: pointer;
        text-shadow: 0 2px 0px rgba(0,0,0,0.2); 
        -webkit-text-stroke: 1.5px var(--dark);
        font-size: 1.1rem;
    }

    #flash {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: white; opacity: 0; pointer-events: none; z-index: 50; transition: opacity 0.1s;
    }
    
    .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 
        10%, 90% { transform: translate3d(-2px, 0, 0); } 
        20%, 80% { transform: translate3d(4px, 0, 0); } 
        30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 
        40%, 60% { transform: translate3d(6px, 0, 0); } 
    }
</style>
</head>
<body>

    <div id="game-container">
        <h1>Flappy Capy</h1>
        <div id="game-score">0</div>
        
        <div id="instruction-text">
            TAP TO FLAP<br>
            <span style="font-size: 3.5rem;">👆</span>
        </div>

        <div id="flash"></div>
        <canvas id="gameCanvas"></canvas>

        <div id="result-screen">
            <div class="card" id="result-card">
                <h2>GAME OVER</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Score</div>
                        <div class="stat-value" id="final-score">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Best</div>
                        <div class="stat-value" id="best-score">0</div>
                    </div>
                    <!-- Coin reward display -->
                    <div class="coin-box">
                        <span class="coin-icon">💰</span> +<span id="coin-reward">0</span>
                    </div>
                </div>

                <button class="btn" onclick="resetGame()">Spill igjen</button>
                <div class="back-link" onclick="window.location.href='https://flodsvin.no'">← Tilbake til meny</div>
            </div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // --- ZOOM & OPPLØSNING ---
    let gameWidth = 320; 
    let gameHeight = 580; 

    function resize() {
        const aspect = window.innerHeight / window.innerWidth;
        if (window.innerWidth < 600) {
            gameWidth = 340; 
            gameHeight = gameWidth * aspect;
        } else {
            gameWidth = 360;
            gameHeight = 640;
        }
        canvas.width = gameWidth;
        canvas.height = gameHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- ELEMENTS ---
    const scoreEl = document.getElementById('game-score');
    const resultScreen = document.getElementById('result-screen');
    const resultCard = document.getElementById('result-card');
    const instructionText = document.getElementById('instruction-text');
    const titleEl = document.querySelector('h1');
    const flashEl = document.getElementById('flash');
    const container = document.getElementById('game-container');
    const coinRewardEl = document.getElementById('coin-reward');

    // --- LOGIKK VARIABLER ---
    let frames = 0;
    let score = 0;
    let highScore = localStorage.getItem('flappyCapyHighScore') || 0;
    let gameState = 'START'; 

    // --- FYSIKK (TUNET FOR BEDRE FEELING) ---
    const GRAVITY = 0.14;       // Lavere tyngdekraft (roligere fall)
    const JUMP_STRENGTH = 4.2;  // Tilpasset hoppstyrke
    const GAME_SPEED = 2.0;     // Behagelig fart

    // --- FUNKSJON FOR MYNTER (RESTAURERT FRA ORIGINALKODEN DIN) ---
    function sendCoinsToMainGame(amount) {
        // Hent eksisterende pending coins
        let pending = parseInt(localStorage.getItem('capy_pending_coins') || '0');
        
        // Sjekk PPC (Points Per Coin) fra localStorage, default til 1
        let ppc = parseInt(localStorage.getItem('capy_ppc') || '1');
        
        // Kalkuler belønning (Bruker formelen din: amount * ppc * 5)
        let reward = amount * ppc * 5; 
        
        // Lagre ny total
        localStorage.setItem('capy_pending_coins', pending + reward);
        
        return reward;
    }

    // --- CHIBI FLODSVIN GRAFIKK (STORE ØYNE/HODE) ---
    const capySvgString = `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
        <filter id="inset"><feFlood flood-color="rgba(0,0,0,0.1)"/><feComposite operator="out" in2="SourceGraphic"/><feGaussianBlur stdDeviation="3"/><feComposite operator="atop" in2="SourceGraphic"/></filter>
        <g id="chibi-capy" filter="url(#inset)">
            <!-- Body (Small) -->
            <ellipse cx="60" cy="140" rx="40" ry="30" fill="#bf9687" stroke="#2d3436" stroke-width="8"/>
            <!-- Head (BIG) -->
            <rect x="40" y="40" width="130" height="100" rx="40" fill="#bf9687" stroke="#2d3436" stroke-width="8"/>
            <!-- Snout (BIG) -->
            <rect x="80" y="90" width="80" height="50" rx="20" fill="#6d4c41"/>
            <!-- Ears -->
            <circle cx="50" cy="45" r="16" fill="#bf9687" stroke="#2d3436" stroke-width="6"/>
            <circle cx="160" cy="45" r="16" fill="#bf9687" stroke="#2d3436" stroke-width="6"/>
            <!-- Eyes (BIG & CUTE) -->
            <circle cx="70" cy="80" r="10" fill="#2d3436"/> 
            <circle cx="140" cy="80" r="10" fill="#2d3436"/>
            <circle cx="73" cy="77" r="3" fill="#fff"/> 
            <circle cx="143" cy="77" r="3" fill="#fff"/>
            <!-- Mouth -->
            <path d="M100 115 L110 125 L120 115" stroke="#2d3436" stroke-width="5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="110" y1="125" x2="110" y2="132" stroke="#2d3436" stroke-width="5" stroke-linecap="round"/>
        </g>
    </svg>`;
    const capyImage = new Image();
    capyImage.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(capySvgString);

    // --- SKYER (PYNT) ---
    const clouds = {
        items: [],
        init: function() {
            this.items = [];
            for(let i=0; i<4; i++) {
                this.items.push({
                    x: Math.random() * gameWidth,
                    y: Math.random() * (gameHeight/2.5),
                    r: 25 + Math.random() * 30,
                    s: 0.1 + Math.random() * 0.3
                });
            }
        },
        draw: function() {
            ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
            for(let c of this.items) {
                ctx.beginPath();
                ctx.arc(c.x, c.y, c.r, 0, Math.PI*2);
                ctx.arc(c.x + c.r*0.7, c.y + c.r*0.1, c.r*0.6, 0, Math.PI*2);
                ctx.arc(c.x - c.r*0.7, c.y + c.r*0.1, c.r*0.6, 0, Math.PI*2);
                ctx.fill();
            }
        },
        update: function() {
            for(let c of this.items) {
                c.x -= c.s;
                if(c.x + c.r * 2 < 0) {
                    c.x = gameWidth + c.r * 2;
                    c.y = Math.random() * (gameHeight/2.5);
                }
            }
        }
    };
    clouds.init();

    // --- FLODSVIN OBJEKT ---
    const capy = {
        x: 50, y: 150, w: 55, h: 55, 
        velocity: 0, 
        rotation: 0,
        draw: function() {
            ctx.save();
            ctx.translate(this.x + this.w/2, this.y + this.h/2);
            
            // Smidigere rotasjon
            let targetRot = 0;
            if (this.velocity < 0) targetRot = -25 * (Math.PI / 180);
            else if (this.velocity > 0) targetRot = Math.min(this.velocity * 0.1, 1.2);
            
            if(gameState === 'PLAYING' || gameState === 'DEAD') {
               this.rotation += (targetRot - this.rotation) * 0.15; 
            } else {
                this.rotation = 0;
            }
            
            ctx.rotate(this.rotation);
            if(gameState !== 'DEAD') {
                ctx.shadowColor = "rgba(0,0,0,0.2)";
                ctx.shadowBlur = 15;
                ctx.shadowOffsetY = 10;
            }
            ctx.drawImage(capyImage, -this.w/2, -this.h/2, this.w, this.h);
            ctx.restore();
        },
        update: function() {
            if (gameState === 'START') {
                this.y = (gameHeight / 2) - 40 + Math.sin(frames * 0.08) * 12;
            } else if (gameState === 'PLAYING') {
                this.velocity += GRAVITY;
                this.y += this.velocity;
                if (this.y + this.h >= gameHeight - fg.h + 10) { 
                    this.y = gameHeight - fg.h + 10 - this.h; 
                    die(); 
                }
                if (this.y < -this.h) { this.velocity = 0; this.y = -this.h; }
            }
        },
        jump: function() { this.velocity = -JUMP_STRENGTH; }
    };

    const fg = {
        h: 90, x: 0, dx: GAME_SPEED,
        draw: function() {
            ctx.fillStyle = '#55efc4'; 
            ctx.fillRect(0, gameHeight - this.h, gameWidth, this.h);
            
            ctx.beginPath(); ctx.moveTo(0, gameHeight - this.h); ctx.lineTo(gameWidth, gameHeight - this.h);
            ctx.strokeStyle = "#2d3436"; ctx.lineWidth = 6; ctx.stroke();

            ctx.fillStyle = '#00b894';
            for (let i = 0; i < gameWidth + 50; i += 50) {
                let offset = this.x % 50;
                ctx.beginPath();
                ctx.arc(i - offset, gameHeight - this.h + 50, 15, 0, Math.PI*2);
                ctx.fill();
            }
        },
        update: function() { if(gameState !== 'DEAD') this.x += this.dx; }
    };

    const pipes = {
        items: [], w: 70, gap: 170, dx: GAME_SPEED,
        draw: function() {
            for(let i = 0; i < this.items.length; i++) {
                let p = this.items[i];
                let bottomY = p.y + p.h + this.gap;
                let colorMain = '#7bed9f';
                let colorDark = '#2ed573';

                ctx.lineWidth = 4; ctx.strokeStyle = '#2d3436';

                // TOP
                ctx.fillStyle = colorMain; ctx.fillRect(p.x, p.y, this.w, p.h); ctx.strokeRect(p.x, p.y, this.w, p.h);
                ctx.fillStyle = colorDark; ctx.fillRect(p.x + this.w - 15, p.y, 10, p.h);
                ctx.fillStyle = colorMain; ctx.fillRect(p.x - 5, p.y + p.h - 35, this.w + 10, 35); ctx.strokeRect(p.x - 5, p.y + p.h - 35, this.w + 10, 35);

                // BOTTOM
                let bH = gameHeight - bottomY - fg.h;
                ctx.fillStyle = colorMain; ctx.fillRect(p.x, bottomY, this.w, bH); ctx.strokeRect(p.x, bottomY, this.w, bH);
                ctx.fillStyle = colorDark; ctx.fillRect(p.x + this.w - 15, bottomY, 10, bH);
                ctx.fillStyle = colorMain; ctx.fillRect(p.x - 5, bottomY, this.w + 10, 35); ctx.strokeRect(p.x - 5, bottomY, this.w + 10, 35);
            }
        },
        update: function() {
            if (frames % 140 === 0) {
                let minPipeH = 40;
                let h = Math.random() * (gameHeight - fg.h - this.gap - 120) + 60;
                this.items.push({ x: gameWidth, y: h - 500, h: 500, passed: false });
            }
            
            for(let i = 0; i < this.items.length; i++) {
                let p = this.items[i];
                p.x -= this.dx;
                
                let hitMargin = 10; 
                let cX = capy.x + hitMargin; let cY = capy.y + hitMargin;
                let cW = capy.w - (hitMargin*2); let cH = capy.h - (hitMargin*2);

                if (cX + cW > p.x && cX < p.x + this.w) {
                    if (cY < p.y + p.h || cY + cH > p.y + p.h + this.gap) die();
                }
                
                if(p.x + this.w < capy.x && !p.passed) { 
                    score++; scoreEl.innerText = score; p.passed = true; 
                    scoreEl.style.transform = "scale(1.4)";
                    setTimeout(()=>scoreEl.style.transform="scale(1)", 150);
                }
                if(p.x + this.w < -60) { this.items.shift(); i--; }
            }
        },
        reset: function() { this.items = []; }
    };

    // --- MAIN LOOP ---
    function loop() {
        let skyGrad = ctx.createLinearGradient(0, 0, 0, gameHeight);
        skyGrad.addColorStop(0, '#48dbfb');
        skyGrad.addColorStop(1, '#c7ecee');
        ctx.fillStyle = skyGrad;
        ctx.fillRect(0, 0, gameWidth, gameHeight);

        clouds.draw(); pipes.draw(); fg.draw(); capy.draw();
        
        clouds.update(); 
        if (gameState !== 'DEAD') { fg.update(); capy.update(); }
        if (gameState === 'PLAYING') { pipes.update(); }
        
        frames++; 
        requestAnimationFrame(loop);
    }

    function inputAction() {
        if (gameState === 'START') {
            gameState = 'PLAYING'; 
            scoreEl.style.display = 'block'; 
            titleEl.style.display = 'none';
            instructionText.style.display = 'none'; 
            capy.jump();
        } else if (gameState === 'PLAYING') {
            capy.jump();
        }
    }

    function die() {
        if(gameState === 'DEAD') return;
        gameState = 'DEAD';
        
        // Effects
        flashEl.style.opacity = 0.6; 
        setTimeout(() => { flashEl.style.opacity = 0; }, 100);
        container.classList.add('shake');
        setTimeout(() => { container.classList.remove('shake'); }, 500);

        // Score logic
        if(score > highScore) { highScore = score; localStorage.setItem('flappyCapyHighScore', highScore); }
        
        // --- COIN LOGIC CALL ---
        // Kaller funksjonen som henter capy_ppc og regner ut total
        let earned = sendCoinsToMainGame(score);

        setTimeout(() => {
            scoreEl.style.display = 'none';
            resultScreen.style.display = 'flex';
            requestAnimationFrame(() => resultCard.classList.add('show'));
            
            document.getElementById('final-score').innerText = score;
            document.getElementById('best-score').innerText = highScore;
            coinRewardEl.innerText = earned.toLocaleString(); // Viser utregnet sum
        }, 600);
    }

    window.resetGame = function() {
        resultCard.classList.remove('show');
        setTimeout(() => {
            gameState = 'START'; 
            capy.y = gameHeight / 2; capy.velocity = 0; capy.rotation = 0;
            score = 0; frames = 0; pipes.reset();
            scoreEl.innerText = "0"; 
            resultScreen.style.display = 'none'; 
            titleEl.style.display = 'block';
            instructionText.style.display = 'block';
        }, 300);
    }

    const handleInput = (e) => {
        if (e.target.closest('.btn') || e.target.closest('.back-link')) return;
        if (e.type === 'touchstart') e.preventDefault();
        inputAction();
    };

    window.addEventListener('mousedown', handleInput);
    window.addEventListener('touchstart', handleInput, {passive: false});
    window.addEventListener('keydown', (e) => { if(e.code === 'Space') inputAction(); });

    loop();
</script>
</body>
</html>